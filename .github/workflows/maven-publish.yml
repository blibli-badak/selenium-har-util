# This workflow will build a package using Maven and then publish it to GitHub packages when a release is created
# For more information see: https://github.com/actions/setup-java/blob/main/docs/advanced-usage.md#apache-maven-with-a-settings-path

name: Maven Package

on:
  release:
    types: [created]
env:
  ## Sets environment variable
  CHROME_MODE: HEADLESS    

jobs:
  build:

    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v3
      with:
        # Use a PAT to push commits back to the repo. Create a repository secret
        # named `PUBLISH_PAT` with a token that has repo write permissions.
        # If you prefer the built-in GITHUB_TOKEN, remove this `token:` line.
        token: ${{ secrets.PUBLISH_PAT }}
        # allow the action to use the token for pushing back to the repo
        persist-credentials: true
        # fetch full history so we can push safely and create commits
        fetch-depth: 0
    - name: Prepare version from release tag
      id: prepare_version
      run: |
        # Use the release tag as VERSION. Tags are expected like "1.3.0".
        TAG="${{ github.event.release.tag_name }}"
        # strip leading 'v' or 'V' if present (safe even if tags don't have 'v')
        VERSION="${TAG#v}"
        VERSION="${VERSION#V}"
        echo "Original tag: $TAG"
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Prepared version: $VERSION"

    - name: Set Maven project version from tag
      run: |
        # Update pom.xml in workspace to use the release tag version (no backup pom)
        mvn -B -DskipTests org.codehaus.mojo:versions-maven-plugin:2.14.2:set -DnewVersion="$VERSION" -DgenerateBackupPoms=false
    - name: Commit pom.xml version change
      run: |
        # Configure git author for the automated commit
        git config user.name "github-actions[bot]" || true
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com" || true

        # Only commit if there are changes (the versions plugin modified the pom)
        if git status --porcelain | grep -q .; then
          git add pom.xml
          git commit -m "ci: set project version to $VERSION [skip ci]" || echo "commit failed or no changes"
          # Push to master. Note: this may fail if branch protection prevents pushes from GITHUB_TOKEN.
          git push origin HEAD:master || echo "push failed (possibly protected branch)"
        else
          echo "No pom.xml changes to commit"
        fi
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        server-id: github # Value of the distributionManagement/repository/id field of the pom.xml
        settings-path: ${{ github.workspace }} # location for the settings.xml file
        
    - uses: browser-actions/setup-chrome@latest
    - name: test chrome
      run: chrome --version

    - name: Build with Maven
      run: mvn -B package --file pom.xml -Dfile.encoding=UTF-8

    - name: Publish to GitHub Packages Apache Maven
      run: mvn deploy -s $GITHUB_WORKSPACE/settings.xml -Dfile.encoding=UTF-8
      env:
        GITHUB_TOKEN: ${{ github.token }}
        USERNAME: ${{ github.actor }}
        
